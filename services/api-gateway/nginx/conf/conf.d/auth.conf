# Authentication configuration
# This location block is used for internal authentication requests

location = /auth {
    internal;
    
    # Pass the request to the user service
    proxy_pass http://user-service:8083/api/v1/auth/validate;
    
    # Strip request body to improve performance
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    
    # Pass the authorization header to validate the token
    proxy_set_header Authorization $http_authorization;
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Original-Method $request_method;
    
    # Cache auth results to minimize requests (5 seconds)
    proxy_cache auth_cache;
    proxy_cache_key "$http_authorization";
    proxy_cache_valid 200 5s;
    proxy_cache_bypass $cookie_nocache $arg_nocache$arg_comment;
    proxy_cache_lock on;
    
    # Don't intercept error responses
    proxy_intercept_errors off;
}

# Cache zone for auth requests to improve performance
proxy_cache_path /var/cache/nginx/auth_cache levels=1:2 keys_zone=auth_cache:1m max_size=10m inactive=5m;